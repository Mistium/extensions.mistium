<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <title>Extensions</title>
    <meta content="Extensions" property="og:title" />
    <meta content="A list of scratch extensions made by @mistium" property="og:description" />
    <meta content="https://extensions.mistium.com" property="og:url" />
    <meta content="#9d81c7" data-react-helmet="true" name="theme-color" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <a class="skip-link" href="#main">Skip to content</a>
    <div id="topbar"></div>
    <header class="site-hero" role="banner">
        <div class="inner">
            <div class="hero-head">
                <img class="brand-avatar" src="https://avatars.rotur.dev/mist" alt="Mistium avatar" />
                <h1 class="site-title">Mistium Extensions</h1>
            </div>
            <p class="tagline">A collection of my experimental TurboWarp extensions.</p>
            <p class="disclaimer" role="note">I build these for fun in my spare time. Some may be unstable or unfinished
                &mdash; use with curiosity. Found a bug? Consider opening a pull request instead of relying on a quick
                fix.</p>
            <div class="controls" aria-label="Extension browsing controls">
                <div class="search-wrapper">
                    <input id="searchInput" type="search" placeholder="Search extensions..."
                        aria-label="Search extensions" autocomplete="off" />
                    <button id="clearSearch" class="icon-btn" aria-label="Clear search" title="Clear search"
                        hidden>&times;</button>
                </div>
                <select id="sortSelect" aria-label="Sort extensions">
                    <option value="featured-first">Sort: Featured first</option>
                    <option value="a-z">Sort: A → Z</option>
                    <option value="z-a">Sort: Z → A</option>
                    <option value="new-updated">Sort: New & Updated</option>
                </select>
                <label class="toggle" title="Toggle theme">
                    <input type="checkbox" id="themeToggle" aria-label="Toggle dark / light theme">
                    <span class="toggle-track"><span class="toggle-thumb" aria-hidden="true"></span></span>
                    <span class="toggle-text" id="themeLabel">Dark</span>
                </label>
            </div>
        </div>
    </header>
    <main id="main" class="content" tabindex="-1">
        <section aria-labelledby="featuredHeading" class="section-block">
            <div class="section-head">
                <h2 id="featuredHeading">Featured</h2>
                <p class="section-sub">Hand‑picked highlights</p>
            </div>
            <div id="featuredCards" class="card-grid" data-grid="featured" aria-live="polite"></div>
        </section>
        <section aria-labelledby="allHeading" class="section-block">
            <div class="section-head">
                <h2 id="allHeading">All Extensions</h2>
                <p class="section-sub">Full list (some may be experimental)</p>
            </div>
            <div id="fileCards" class="card-grid" data-grid="all" aria-live="polite"></div>
            <div id="emptyState" class="empty-state" hidden>No extensions match your search.</div>
        </section>
        <section aria-labelledby="otherHeading" class="section-block">
            <div class="section-head">
                <h2 id="otherHeading">Other Extension Galleries</h2>
                <p class="section-sub">Explore more community resources</p>
            </div>
            <div id="otherGalleries" class="card-grid small" aria-live="polite"></div>
        </section>
        <footer class="site-footer">
            <p><strong>Tip:</strong> Right‑click an extension link and copy its URL to add it to TurboWarp.</p>
            <p class="tiny">&copy; <span id="year"></span> Mistium • MIT licensed site • Images & individual extensions
                may have separate licenses.</p>
        </footer>
        <div class="footer-spacer" aria-hidden="true"></div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initCardEffects();
            initTheme();
            initKeyboardFocusStyles();
            fetch('https://raw.githubusercontent.com/Mistium/Origin-OS/main/topbar.html')
                .then(response => response.text())
                .then(html => { document.getElementById('topbar').innerHTML = html; })
                .catch(error => console.error('Error fetching topbar HTML:', error));

            fetchAndCacheVersions().then(() => {
                generateProfileCards().then(() => {
                    setupFilteringAndSorting();
                });
                generateOtherGalleries();
            });
            document.getElementById('year').textContent = new Date().getFullYear();
        });

        // Card interactive effects
        function initCardEffects() {
            document.addEventListener('mousemove', e => {
                const cards = document.querySelectorAll('.profile-card, .gallery-card, .project-card, .about');

                cards.forEach(card => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    card.style.setProperty('--mouse-x', `${x}px`);
                    card.style.setProperty('--mouse-y', `${y}px`);
                });
            });
        }

        // Function to fetch versions data and cache it
        async function fetchAndCacheVersions() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/Mistium/extensions.mistium/main/versions.json');
                const versions = await response.json();
                localStorage.setItem('extensionVersions', JSON.stringify(versions));
                return versions;
            } catch (error) {
                console.error('Error fetching versions data:', error);
                return {};
            }
        }

        // Function to fetch data from GitHub API
        async function fetchData() {
            try {
                const [featuredResponse, filesResponse] = await Promise.all([
                    fetch('https://api.github.com/repos/Mistium/extensions.mistium/contents/featured'),
                    fetch('https://api.github.com/repos/Mistium/extensions.mistium/contents/files')
                ]);
                const featuredData = await featuredResponse.json();
                const filesData = await filesResponse.json();
                return { featured: featuredData, files: filesData };
            } catch (error) {
                console.error('Error fetching data:', error);
                return { featured: [], files: [] };
            }
        }

        // Function to generate profile cards
        async function generateProfileCards() {
            const featuredCardsContainer = document.getElementById("featuredCards");
            const fileCardsContainer = document.getElementById("fileCards");
            const data = await fetchData();

            let cachedVersions = {};
            try {
                cachedVersions = JSON.parse(localStorage.getItem('extensionVersions')) || {};
            } catch (e) {
                console.error('Error parsing cached versions:', e);
            }

            const versions = await fetchAndCacheVersions();

            if (!data || !data.featured || !Array.isArray(data.featured) || !data.files || !Array.isArray(data.files)) return;

            data.featured.forEach(item => {
                const itemName = item.name.split('.')[0]; // Remove file extension
                const isJsFile = item.name.endsWith('.js');

                if (isJsFile) {
                    const profileCardLink = document.createElement("a");
                    const download_url = item.download_url.replace("raw.githubusercontent.com/Mistium/extensions.mistium/main/", "extensions.mistium.com/")
                    profileCardLink.href = download_url;
                    profileCardLink.target = "_blank";
                    profileCardLink.rel = "noopener noreferrer";
                    profileCardLink.classList.add("gallery-link");
                    profileCardLink.setAttribute('data-name', itemName.toLowerCase());
                    profileCardLink.setAttribute('data-featured', 'true');
                    profileCardLink.setAttribute('data-url', download_url);
                    profileCardLink.setAttribute('data-raw-url', item.download_url);

                    const profileCard = document.createElement("div");
                    profileCard.classList.add("profile-card");
                    profileCard.setAttribute('tabindex', '0');
                    profileCard.setAttribute('role', 'article');
                    profileCard.setAttribute('aria-label', itemName + ' extension');

                    const cardContent = document.createElement("div");
                    cardContent.classList.add("card-content");

                    const profileImage = document.createElement("img");
                    profileImage.src = `https://raw.githubusercontent.com/Mistium/extensions.mistium/main/images/${itemName}.png`;
                    profileImage.alt = itemName;
                    profileImage.classList.add("profile-image");
                    profileImage.loading = 'lazy';
                    profileImage.addEventListener('error', () => { profileImage.src = 'https://avatars.githubusercontent.com/u/175630084?s=200&v=4'; profileImage.classList.add('fallback'); });

                    const platformHeading = document.createElement("h2");
                    platformHeading.textContent = itemName;

                    // Check if the extension is new or updated
                    const versionTag = document.createElement("span");
                    versionTag.classList.add("version-tag");
                    if (!cachedVersions[item.name]) {
                        versionTag.textContent = "New";
                        versionTag.classList.add("new-tag");
                    } else if (versions[item.name] && versions[item.name] !== cachedVersions[item.name]) {
                        versionTag.textContent = "Updated";
                        versionTag.classList.add("updated-tag");
                    }

                    cardContent.appendChild(profileImage);
                    cardContent.appendChild(platformHeading);
                    const desc = document.createElement('p');
                    desc.className = 'ext-desc';
                    desc.textContent = 'Loading description...';
                    cardContent.appendChild(desc);
                    if (versionTag.textContent) {
                        platformHeading.appendChild(versionTag);
                    }

                    // Actions
                    const actions = document.createElement('div');
                    actions.className = 'card-actions';
                    const copyBtn = document.createElement('button');
                    copyBtn.type = 'button';
                    copyBtn.className = 'icon-btn copy-btn';
                    copyBtn.setAttribute('aria-label', 'Copy extension URL');
                    copyBtn.innerHTML = '<span class="icon">Copy Url</span>';
                    copyBtn.dataset.url = download_url;
                    const warpLink = document.createElement('a');
                    warpLink.className = 'icon-btn warp-btn';
                    warpLink.href = `https://warp.mistium.com/editor.html?extension=${encodeURIComponent(download_url)}`;
                    warpLink.target = '_blank';
                    warpLink.rel = 'noopener noreferrer';
                    warpLink.setAttribute('aria-label', 'Open in MistWarp');
                    warpLink.innerHTML = '<span class="icon">MistWarp</span>';
                    actions.append(copyBtn, warpLink);

                    profileCard.appendChild(cardContent);
                    profileCard.appendChild(actions);
                    profileCardLink.appendChild(profileCard);
                    featuredCardsContainer.appendChild(profileCardLink);
                }
            });

            data.files.forEach(item => {
                const itemName = item.name.split('.')[0]; // Remove file extension
                const isJsFile = item.name.endsWith('.js');

                if (isJsFile) {
                    const profileCardLink = document.createElement("a");
                    const download_url = item.download_url.replace("raw.githubusercontent.com/Mistium/extensions.mistium/main/", "extensions.mistium.com/")
                    profileCardLink.href = download_url;
                    profileCardLink.target = "_blank";
                    profileCardLink.rel = "noopener noreferrer";
                    profileCardLink.classList.add("gallery-link");
                    profileCardLink.setAttribute('data-name', itemName.toLowerCase());
                    profileCardLink.setAttribute('data-featured', 'false');
                    profileCardLink.setAttribute('data-url', download_url);
                    profileCardLink.setAttribute('data-raw-url', item.download_url);

                    const profileCard = document.createElement("div");
                    profileCard.classList.add("profile-card");
                    profileCard.setAttribute('tabindex', '0');
                    profileCard.setAttribute('role', 'article');
                    profileCard.setAttribute('aria-label', itemName + ' extension');

                    const cardContent = document.createElement("div");
                    cardContent.classList.add("card-content");
                    
                    const platformHeading = document.createElement("h2");
                    platformHeading.textContent = itemName;
                    const versionTag = document.createElement("span");
                    versionTag.classList.add("version-tag");
                    if (!cachedVersions[item.name]) {
                        versionTag.textContent = "New";
                        versionTag.classList.add("new-tag");
                    } else if (versions[item.name] && versions[item.name] !== cachedVersions[item.name]) {
                        versionTag.textContent = "Updated";
                        versionTag.classList.add("updated-tag");
                    }
                    if (versionTag.textContent) platformHeading.appendChild(versionTag);
                    cardContent.appendChild(platformHeading);
                    const desc = document.createElement('p');
                    desc.className = 'ext-desc';
                    desc.textContent = 'Loading description...';
                    cardContent.appendChild(desc);

                    const actions = document.createElement('div');
                    actions.className = 'card-actions';
                    const copyBtn = document.createElement('button');
                    copyBtn.type = 'button';
                    copyBtn.className = 'icon-btn copy-btn';
                    copyBtn.setAttribute('aria-label', 'Copy extension URL');
                    copyBtn.innerHTML = '<span>Copy Url</span>';
                    copyBtn.dataset.url = download_url;
                    const warpLink = document.createElement('a');
                    warpLink.className = 'icon-btn warp-btn';
                    warpLink.href = `https://warp.mistium.com/editor.html?extension=${encodeURIComponent(download_url)}`;
                    warpLink.target = '_blank';
                    warpLink.rel = 'noopener noreferrer';
                    warpLink.setAttribute('aria-label', 'Open in MistWarp');
                    warpLink.innerHTML = '<span class="icon">MistWarp</span>';
                    actions.append(copyBtn, warpLink);

                    profileCard.appendChild(cardContent);
                    profileCard.appendChild(actions);
                    profileCardLink.appendChild(profileCard);
                    fileCardsContainer.appendChild(profileCardLink);
                }
            });

            // Update the cached versions to the latest versions
            localStorage.setItem('extensionVersions', JSON.stringify(versions));
            // After initial render load descriptions
            loadDescriptions();
            return true;
        }

        // Function to generate other extension gallery links
        function generateOtherGalleries() {
            const galleries = [
                { name: "PenguinMod", url: "https://extensions.penguinmod.com" },
                { name: "Cally's Gallery", url: "https://cally-jt.github.io/ultimate-extension-gallery" },
                { name: "Sharkpool", url: "https://sharkpools-extensions.vercel.app" },
                { name: "Ruby Team Gallery", url: "https://ruby-devs.vercel.app/gallery" },
                { name: "TurboWarp", url: "https://extensions.turbowarp.org" },
                { name: "LDSJVG Webwave", url: "https://ldsjvg.webwave.dev/webpage_20" },
                { name: "LBGS Extensions", url: "https://lbgs-extensions.vercel.app/" },
                { name: "Goofy Warp", url: "https://goofywarp.github.io/extensions/" },
                { name: "Dino Mod :P", url: "https://github.com/GabsTheCuriousKid/FirstExtension/tree/main/extensions" },
                { name: "Pen Group", url: "https://pen-group.github.io/extensions" },
                { name: "Lemon", url: "https://bludisanlemon.github.io/lemons-gallery" },
                { name: "Kubi's Extensions", url: "https://sillikubi.github.io/ExtensionPage/Projectspage.html" },
                { name: "CST's Extensions", url: "https://cst1229.eu.org/extensions" },
                { name: "ElmoBear's Extensions", url: "https://kylekart.github.io/ScratchExtensions" },
                { name: "Flufi's Gallery", url: "https://gallery.flufi.gay" },
                { name: "Greedy Allay Extensions", url: "https://greedyallay.github.io/extensions" },
            ];

            const otherGalleriesContainer = document.getElementById("otherGalleries");

            galleries.forEach(gallery => {
                const galleryLink = document.createElement("a");
                galleryLink.href = gallery.url + "?ref=mistium";
                galleryLink.target = "_blank";
                galleryLink.rel = "noopener noreferrer";
                galleryLink.classList.add("gallery-link");
                galleryLink.setAttribute('data-name', gallery.name.toLowerCase());

                const galleryCard = document.createElement("div");
                galleryCard.classList.add("profile-card");
                galleryCard.setAttribute('tabindex', '0');
                galleryCard.setAttribute('role', 'article');
                galleryCard.setAttribute('aria-label', gallery.name + ' gallery link');

                const cardContent = document.createElement("div");
                cardContent.classList.add("card-content");

                const galleryHeading = document.createElement("h2");
                galleryHeading.textContent = gallery.name;

                cardContent.appendChild(galleryHeading);
                galleryCard.appendChild(cardContent);
                galleryLink.appendChild(galleryCard);
                otherGalleriesContainer.appendChild(galleryLink);
            });
        }

        // === UX Enhancements ===
        function setupFilteringAndSorting() {
            const searchInput = document.getElementById('searchInput');
            const clearBtn = document.getElementById('clearSearch');
            const sortSelect = document.getElementById('sortSelect');
            const emptyState = document.getElementById('emptyState');
            const featuredContainer = document.getElementById('featuredCards');
            const allContainer = document.getElementById('fileCards');

            function apply() {
                const term = searchInput.value.trim().toLowerCase();
                const sort = sortSelect.value;
                const featuredCards = Array.from(featuredContainer.querySelectorAll('.gallery-link'));
                const allCards = Array.from(allContainer.querySelectorAll('.gallery-link'));
                const combined = [...featuredCards, ...allCards];

                let visibleCount = 0;
                combined.forEach(link => {
                    const name = link.getAttribute('data-name');
                    const match = !term || name.includes(term);
                    link.toggleAttribute('hidden', !match);
                    if (match) visibleCount++;
                });

                emptyState.hidden = visibleCount !== 0;

                // Sorting
                function nameOf(el) { return el.getAttribute('data-name'); }
                // We'll always sort ONLY the non-featured list except when user explicitly picks a-z or z-a and wants consistency
                const nonFeatured = allCards.filter(el => !el.hasAttribute('hidden'));
                if (sort === 'a-z') nonFeatured.sort((a, b) => nameOf(a).localeCompare(nameOf(b)));
                else if (sort === 'z-a') nonFeatured.sort((a, b) => nameOf(b).localeCompare(nameOf(a)));
                else if (sort === 'new-updated') {
                    nonFeatured.sort((a, b) => {
                        const av = a.querySelector('.version-tag');
                        const bv = b.querySelector('.version-tag');
                        const as = av ? (av.classList.contains('new-tag') ? 2 : 1) : 0;
                        const bs = bv ? (bv.classList.contains('new-tag') ? 2 : 1) : 0;
                        if (bs - as !== 0) return bs - as;
                        return nameOf(a).localeCompare(nameOf(b));
                    });
                } else if (sort === 'featured-first') {
                    // No changes to containers; ensure featured visible ones unaffected
                }
                if (sort !== 'featured-first') {
                    const frag = document.createDocumentFragment();
                    nonFeatured.forEach(el => frag.appendChild(el));
                    allContainer.appendChild(frag);
                }
                clearBtn.hidden = term.length === 0;
            }

            searchInput.addEventListener('input', apply);
            sortSelect.addEventListener('change', apply);
            clearBtn.addEventListener('click', () => { searchInput.value = ''; apply(); searchInput.focus(); });
            apply();
        }

        function initTheme() {
            const toggle = document.getElementById('themeToggle');
            const label = document.getElementById('themeLabel');
            const saved = localStorage.getItem('theme') || 'dark';
            document.documentElement.dataset.theme = saved;
            toggle.checked = saved === 'light';
            label.textContent = saved === 'light' ? 'Light' : 'Dark';
            toggle.addEventListener('change', () => {
                const mode = toggle.checked ? 'light' : 'dark';
                document.documentElement.dataset.theme = mode;
                localStorage.setItem('theme', mode);
                label.textContent = mode === 'light' ? 'Light' : 'Dark';
            });
        }

        function initKeyboardFocusStyles() {
            function handleFirstTab(e) {
                if (e.key === 'Tab') {
                    document.documentElement.classList.add('user-tabbing');
                    window.removeEventListener('keydown', handleFirstTab);
                }
            }
            window.addEventListener('keydown', handleFirstTab);
        }

        // Copy button handler (event delegation)
        document.addEventListener('click', e => {
            const btn = e.target.closest('.copy-btn');
            if (!btn) return;
            const url = btn.dataset.url;
            if (!url) return;
            navigator.clipboard.writeText(url).then(() => {
                const original = btn.innerHTML;
                btn.classList.add('copied');
                btn.innerHTML = '<span class="icon">✅</span>';
                setTimeout(() => { btn.classList.remove('copied'); btn.innerHTML = original; }, 1500);
            }).catch(() => {
                btn.innerHTML = '<span class="icon">⚠️</span>';
                setTimeout(() => { btn.innerHTML = '<span class="icon">📋</span>'; }, 1500);
            });
        });

        // Load descriptions from raw JS files (looks for // Description: ... )
        function loadDescriptions() {
            const links = Array.from(document.querySelectorAll('.gallery-link'));
            const tasks = links.map(link => ({ link, raw: link.getAttribute('data-raw-url') }));
            const limit = 5; // concurrency limit
            let index = 0;
            function next() {
                if (index >= tasks.length) return;
                const batch = tasks.slice(index, index + limit);
                index += limit;
                Promise.all(batch.map(t => fetch(t.raw).then(r => r.ok ? r.text() : '').then(txt => ({ ...t, txt })).catch(() => ({ ...t, txt: '' }))))
                    .then(results => {
                        results.forEach(res => {
                            if (!res.txt) return;
                            const m = res.txt.match(/^[ \t]*\/\/\s*Description\s*:\s*(.+)$/im);
                            const descText = m ? m[1].trim() : null;
                            const p = res.link.querySelector('.ext-desc');
                            if (p) {
                                p.textContent = descText ? truncate(descText, 140) : 'No description available yet.';
                            }
                        });
                        next();
                    });
            }
            function truncate(str, max) { return str.length > max ? str.slice(0, max - 1) + '…' : str; }
            next();
        }
    </script>

</body>

</html>